<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekboodschappen</title>
  <style>
    :root {
      --bg: #f1f5f9;
      --card: #ffffff;
      --primary: #0f766e;
      --primary-hover: #14b8a6;
      --accent: #7c3aed;
      --danger: #ef4444;
      --text: #0f172a;
      --muted: #64748b;
      --radius: 12px;
    }
    body { font-family: 'Inter', system-ui, sans-serif; margin:0; background:var(--bg); color:var(--text); display:flex; justify-content:center; padding:20px; }
    .app { width:100%; max-width:720px; background:var(--card); border-radius:var(--radius); box-shadow:0 4px 16px rgba(0,0,0,0.08); padding:20px; position:relative; z-index:1; }
    h1 { margin-top:0; font-size:1.5rem; color:var(--primary); }
    .section-label { font-size:1rem; font-weight:600; margin:16px 0 8px; color:var(--muted); }

    /* Meals */
    .meal-row { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
    .meal-row button { background:var(--primary); color:#fff; border:none; border-radius:8px; padding:10px 18px; cursor:pointer; font-size:1rem; font-weight:500; transition:background .2s; }
    .meal-row button:hover { background:var(--primary-hover); }
    .meal-row button.active { background:var(--accent); }

    /* Weeklies accordion */
    .weekly-accordion { display:flex; flex-direction:column; gap:12px; }
    .weekly-group { background:#f1f5f9; border:1px solid #e2e8f0; border-radius:var(--radius); overflow:hidden; }
    .weekly-group__header { width:100%; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; background:#eef2ff; border:none; cursor:pointer; font-size:.95rem; font-weight:600; color:#0f172a; }
    .weekly-group__header.active { background:#eaefff; }
    .weekly-group__title { display:flex; align-items:center; gap:8px; }
    .weekly-group__chev { font-weight:700; width:1.1em; text-align:center; }
    .weekly-group__badge { background:#e2e8f0; border-radius:999px; padding:2px 10px; font-size:.75rem; color:#0f172a; }
    .weekly-group__content { display:none; padding:12px; background:#fff; }
    .weekly-group.open .weekly-group__content { display:flex; flex-wrap:wrap; gap:8px; }
    .weekly-group__content button { background:#e2e8f0; color:var(--text); border:none; border-radius:999px; padding:6px 14px; cursor:pointer; font-size:.85rem; transition:background .2s; }
    .weekly-group__content button:hover { background:#cbd5e1; }
    .weekly-group__content button.active { background:var(--accent); color:#fff; }

    .counter { font-weight:500; margin:16px 0 8px; color:var(--muted); }

    /* Shopping list */
    .shopping-list { list-style:none; padding:0; margin:0; }
    .section-header { margin-top:16px; font-weight:600; color:var(--primary); font-size:1.1rem; border-bottom:1px solid #e2e8f0; padding-bottom:4px; cursor:default; }
    .shopping-list li { padding:6px 10px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition:background .2s; }
    .shopping-list li:hover { background:#f1f5f9; }
    .shopping-list small { color:var(--muted); font-size:.75rem; }
    .shopping-list li.crossed { text-decoration:line-through; color:var(--muted); }

    /* Custom input */
    .custom-input { display:flex; gap:8px; margin-top:20px; }
    .custom-input input { flex:1; padding:8px 12px; border:1px solid #cbd5e1; border-radius:var(--radius); font-size:.9rem; }
    .custom-input button { background:var(--primary); color:#fff; border:none; border-radius:var(--radius); padding:8px 14px; cursor:pointer; font-size:.9rem; }
    .custom-input button:hover { background:var(--primary-hover); }

    /* Floating clear */
    .clear-list { position:fixed; bottom:20px; right:20px; background:var(--danger); color:#fff; border:none; border-radius:999px; padding:10px 16px; font-size:.85rem; font-weight:500; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.15); transition:background .2s; }
    .clear-list:hover { background:#dc2626; }
  </style>
</head>
<body>
  <div class="app">
    <h1>Weekboodschappen</h1>

    <h2 class="section-label">üç≤ Maaltijden</h2>
    <div class="meal-row" id="mealRow"></div>

    <h2 class="section-label">üì¶ Weekboodschappen</h2>
    <div id="weeklyAccordion" class="weekly-accordion"></div>

    <div class="counter" id="mealCounter">Je hebt maaltijden geselecteerd voor 0 dagen</div>
    <ul class="shopping-list" id="shoppingList"></ul>

    <div class="custom-input">
      <input type="text" id="customItemInput" placeholder="Eigen item toevoegen..." />
      <button id="customAddBtn">Voeg toe</button>
    </div>

    <button id="clearListBtn" class="clear-list">üóëÔ∏è Lijst leegmaken</button>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>

<script>
/* ---------- Firebase init (fill your config) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCZWsoDIQYwCF-V2QuvYjxrFGB84gRnHFo",
  authDomain: "grocify-2fd51.firebaseapp.com",
  projectId: "grocify-2fd51"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* One shared list for everyone */
const HOUSEHOLD_ID = "shared";
const itemsCol = db.collection('households').doc(HOUSEHOLD_ID).collection('listItems');

/* Helpers */
const inc    = firebase.firestore.FieldValue.increment;
const arrAdd = firebase.firestore.FieldValue.arrayUnion;
const arrDel = firebase.firestore.FieldValue.arrayRemove;
function slug(name){ return name.toLowerCase().trim().replace(/\s+/g,'-').replace(/[^\w-]/g,''); }

/* ---------- Supermarket order ---------- */
const sectionOrder = [
  "Groente & Fruit","Vega","Brood","Ontbijt & Smeersels","Zuivel",
  "Pasta & Rijst","Kruiden & Specerijen","Chips & Snacks","Non-food","Diepvries","Toiletartikelen","Eigen"
];

/* ---------- Meals ---------- */
const mealData = {
  "Pizza": ["Pizzadeeg","Gesneden Champignons","Paprika","Paprika","Rode Ui","Tapenade","Cashewnoten"],
  "Sticky Tofu": ["Tofu","Broccoli","Rijst azijn","Maizena","Sojasaus","Knoflook"],
  "Stamppot Spinazie": ["Burger","Kruimige Aardappelen","Spinazie fijn diepvries"],
  "Pasta": ["Paprika","Paprika","Gehakt","Winterpeen","Tomatenpuree","Cherry Tomaten blik","Saus zongedroogde tomaat","Ui wit","Knoflook"],
  "Chili Sin Carne": ["Ui wit","Knoflook","Koriander","Chilipoeder","Komijnzaad","Zoete Aardappels","Zoete Aardappels","Tomatenblokjes (400gr)","Bosui","Bosui","Cr√®me Fra√Æche (125ml)","Avocado","Ma√Øskorrels (100gr)","Kidneybonen (100gr)"],
  "Couscous Boerenkool": ["Ui wit","Knoflook","Chilipoeder","Boerenkool (300gr)","Couscous (200gr)","Rozijnen (50gr)","Kruidenbouillon (600ml)"]
};

/* ---------- Weeklies (accordion groups) ---------- */
const weeklyGroupsData = {
  "Ontbijt & Lunch": ["Brood","Pindakaas","Hagelslag","Sojayoghurt","Havermout","Havermelk","Cruesli","Hummus","Rozijnen (50gr)"],
  "Toiletartikelen": ["Toiletpapier","Zeep","Wasmiddel","Shampoo","Tandpasta","Afwasmiddel","Keukenpapier"],
  "Vers": ["Blauwe Bessen","Bananen","Avocado","Avocado","Avocado","Avocado"],
  "Meisjes": ["Groenvoer","Hooi","Brokjes"],
  "Baby": ["Luiers","Babydoekjes","Kunstvoeding"],
  "Appelschilletjes": ["Chocola","Chips","Big Hit","Drop","Apekoppen"]
};

/* ---------- Mapping: item ‚Üí section ---------- */
const itemToSection = {
  // Groente & Fruit
  "Paprika":"Groente & Fruit","Rode Ui":"Groente & Fruit","Ui wit":"Groente & Fruit",
  "Knoflook":"Groente & Fruit","Broccoli":"Groente & Fruit","Zoete Aardappels":"Groente & Fruit",
  "Gesneden Champignons":"Groente & Fruit","Bosui":"Groente & Fruit","Avocado":"Groente & Fruit",
  "Blauwe Bessen":"Groente & Fruit","Bananen":"Groente & Fruit","Winterpeen":"Groente & Fruit",
  "Boerenkool (300gr)":"Groente & Fruit","Groenvoer":"Groente & Fruit",

  // Vega
  "Tofu":"Vega","Burger":"Vega","Gehakt":"Vega",

  // Brood
  "Brood":"Brood","Pizzadeeg":"Brood",

  // Ontbijt & Smeersels
  "Pindakaas":"Ontbijt & Smeersels","Hagelslag":"Ontbijt & Smeersels","Sojayoghurt":"Ontbijt & Smeersels",
  "Havermout":"Ontbijt & Smeersels","Havermelk":"Ontbijt & Smeersels","Cruesli":"Ontbijt & Smeersels",
  "Tapenade":"Ontbijt & Smeersels","Hummus":"Ontbijt & Smeersels","Rozijnen (50gr)":"Ontbijt & Smeersels",

  // Zuivel
  "Cr√®me Fra√Æche (125ml)":"Zuivel",

  // Pasta & Rijst
  "Rijst azijn":"Pasta & Rijst","Maizena":"Pasta & Rijst","Sojasaus":"Pasta & Rijst",
  "Tomatenpuree":"Pasta & Rijst","Saus zongedroogde tomaat":"Pasta & Rijst","Cherry Tomaten blik":"Pasta & Rijst",
  "Tomatenblokjes (400gr)":"Pasta & Rijst","Couscous (200gr)":"Pasta & Rijst","Kruidenbouillon (600ml)":"Pasta & Rijst",

  // Kruiden & Specerijen
  "Chilipoeder":"Kruiden & Specerijen","Komijnzaad":"Kruiden & Specerijen","Koriander":"Kruiden & Specerijen",

  // Chips & Snacks
  "Cashewnoten":"Chips & Snacks","Chocola":"Chips & Snacks","Chips":"Chips & Snacks","Big Hit":"Chips & Snacks","Drop":"Chips & Snacks","Apekoppen":"Chips & Snacks",

  // Non-food
  "Hooi":"Non-food","Brokjes":"Non-food","Luiers":"Non-food","Babydoekjes":"Non-food","Kunstvoeding":"Non-food",

  // Diepvries
  "Spinazie fijn diepvries":"Diepvries",

  // Toiletartikelen
  "Toiletpapier":"Toiletartikelen","Zeep":"Toiletartikelen","Wasmiddel":"Toiletartikelen",
  "Shampoo":"Toiletartikelen","Tandpasta":"Toiletartikelen","Afwasmiddel":"Toiletartikelen","Keukenpapier":"Toiletartikelen"
};

/* ---------- Local (derived from cloud) ---------- */
let activeMeals = new Set();  // only for the counter
let activeItems = {};         // { name: { count, sources:Set, checked } }

/* ---------- Auth + realtime ---------- */
auth.signInAnonymously().catch(console.error);
auth.onAuthStateChanged(async () => {
  try { await db.enablePersistence(); } catch(e) { /* ok if not supported */ }
  itemsCol.onSnapshot(snap => {
    const docs = snap.docs.map(d => d.data());
    setActiveFromCloud(docs);
  });
});

/* ---------- Cloud writes ---------- */
async function cloudAddItem(name, section, origin){
  const id = slug(name);
  await itemsCol.doc(id).set({
    name, section,
    count: inc(1),
    origins: arrAdd(origin),
    checked: false,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });
}
async function cloudRemoveItem(name, origin){
  const id = slug(name);
  await db.runTransaction(async tx => {
    const ref = itemsCol.doc(id);
    const snap = await tx.get(ref);
    if(!snap.exists) return;
    const data = snap.data();
    const newCount = (data.count || 0) - 1;
    if(newCount <= 0) tx.delete(ref);
    else tx.update(ref, { count: newCount, origins: arrDel(origin) });
  });
}
async function cloudToggleChecked(name, checked){
  await itemsCol.doc(slug(name)).set({ checked }, { merge:true });
}
async function cloudClearList(){
  const snap = await itemsCol.get();
  const batch = db.batch();
  snap.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
}

/* ---------- Meals UI ---------- */
function renderMeals(){
  const row = document.getElementById("mealRow");
  row.innerHTML = "";
  for(const meal in mealData){
    const btn = document.createElement("button");
    btn.textContent = meal;
    btn.onclick = async () => {
      const isActive = btn.classList.toggle("active");
      if(isActive){
        activeMeals.add(meal);
        for(const item of mealData[meal]){
          const sec = itemToSection[item] || "Eigen";
          cloudAddItem(item, sec, meal);
        }
      }else{
        activeMeals.delete(meal);
        for(const item of mealData[meal]){
          cloudRemoveItem(item, meal);
        }
      }
      updateCounter();
    };
    row.appendChild(btn);
  }
}

/* ---------- Weeklies Accordion UI ---------- */
function renderWeeklies(){
  const container = document.getElementById("weeklyAccordion");
  container.innerHTML = "";

  Object.keys(weeklyGroupsData).forEach(group => {
    const card = document.createElement("div");
    card.className = "weekly-group";
    card.dataset.group = group;

    const header = document.createElement("button");
    header.className = "weekly-group__header";
    header.onclick = () => toggleWeeklyGroupAccordion(group);

    const titleWrap = document.createElement("span");
    titleWrap.className = "weekly-group__title";

    const chev = document.createElement("span");
    chev.className = "weekly-group__chev";
    chev.textContent = "‚ñ∫";

    const title = document.createElement("span");
    title.textContent = group;

    titleWrap.append(chev, title);

    const badge = document.createElement("span");
    badge.className = "weekly-group__badge";
    badge.textContent = "0 geselecteerd";

    header.append(titleWrap, badge);

    const content = document.createElement("div");
    content.className = "weekly-group__content";
    content.id = `group-${group}`;

    weeklyGroupsData[group].forEach(item => {
      const b = document.createElement("button");
      b.textContent = item;
      b.dataset.item = item;
      b.onclick = () => {
        const active = b.classList.toggle("active");
        if(active){
          const sec = itemToSection[item] || "Eigen";
          cloudAddItem(item, sec, group);
        }else{
          cloudRemoveItem(item, group);
        }
        updateWeeklyBadge(group);
      };
      content.appendChild(b);
    });

    card.append(header, content);
    container.appendChild(card);
    updateWeeklyBadge(group);
  });

  // reflect current cloud selections in buttons after first load
  syncWeeklySelectionsFromCloud();
}

function toggleWeeklyGroupAccordion(groupName){
  const cards = document.querySelectorAll(".weekly-group");
  cards.forEach(card => {
    const header = card.querySelector(".weekly-group__header");
    const chev = card.querySelector(".weekly-group__chev");
    const isTarget = card.dataset.group === groupName;
    if(isTarget){
      const willOpen = !card.classList.contains("open");
      card.classList.toggle("open", willOpen);
      chev.textContent = willOpen ? "‚ñº" : "‚ñ∫";
      header.classList.toggle("active", willOpen);
      if(willOpen) card.scrollIntoView({ behavior:"smooth", block:"start" });
    }else{
      card.classList.remove("open");
      header.classList.remove("active");
      const otherChev = card.querySelector(".weekly-group__chev");
      if(otherChev) otherChev.textContent = "‚ñ∫";
    }
  });
}

function updateWeeklyBadge(groupName){
  const count = Object.entries(activeItems)
    .filter(([_, data]) => data.sources.has(groupName))
    .length;
  const card = document.querySelector(`.weekly-group[data-group="${CSS.escape(groupName)}"]`);
  if(!card) return;
  const badge = card.querySelector(".weekly-group__badge");
  badge.textContent = count === 1 ? "1 geselecteerd" : `${count} geselecteerd`;
}
function updateAllWeeklyBadges(){
  Object.keys(weeklyGroupsData).forEach(updateWeeklyBadge);
}
function syncWeeklySelectionsFromCloud(){
  Object.keys(weeklyGroupsData).forEach(group => {
    const content = document.getElementById(`group-${group}`);
    if(!content) return;
    content.querySelectorAll("button").forEach(btn => {
      const item = btn.dataset.item;
      const cloud = activeItems[item];
      const shouldBeActive = !!(cloud && cloud.sources.has(group));
      btn.classList.toggle("active", shouldBeActive);
    });
    updateWeeklyBadge(group);
  });
}

/* ---------- Shopping list ---------- */
function updateCounter(){
  document.getElementById("mealCounter").textContent =
    "Je hebt maaltijden geselecteerd voor " + activeMeals.size + " dagen";
}
function setActiveFromCloud(cloudDocs){
  activeItems = {};
  cloudDocs.forEach(d => {
    activeItems[d.name] = {
      count: d.count || 1,
      sources: new Set(d.origins || []),
      checked: !!d.checked
    };
  });
  renderList();
  syncWeeklySelectionsFromCloud();
  updateAllWeeklyBadges();
}
function renderList(){
  const ul = document.getElementById("shoppingList");
  ul.innerHTML = "";

  sectionOrder.forEach(section => {
    const items = Object.keys(activeItems).filter(i => (itemToSection[i] || "Eigen") === section);
    if(items.length > 0){
      const header = document.createElement("li");
      header.className = "section-header";
      header.textContent = section;
      ul.appendChild(header);

      items.forEach(name => {
        const data = activeItems[name];
        const li = document.createElement("li");
        const label = data.count > 1 ? `${name} (${data.count}x)` : name;

        const span = document.createElement("span");
        span.textContent = label;

        const small = document.createElement("small");
        small.textContent = Array.from(data.sources).join(", ");

        li.append(span, small);
        li.classList.toggle("crossed", !!data.checked);
        li.onclick = () => cloudToggleChecked(name, !li.classList.contains("crossed"));

        ul.appendChild(li);
      });
    }
  });
}

/* ---------- Custom input ---------- */
document.getElementById("customAddBtn").addEventListener("click", addCustomItem);
document.getElementById("customItemInput").addEventListener("keydown", e => {
  if(e.key === "Enter"){ e.preventDefault(); addCustomItem(); }
});
function addCustomItem(){
  const input = document.getElementById("customItemInput");
  const value = input.value.trim();
  if(!value) return;
  const sec = itemToSection[value] || "Eigen";
  cloudAddItem(value, sec, "Eigen");
  input.value = "";
}

/* ---------- Clear list ---------- */
document.getElementById("clearListBtn").addEventListener("click", async () => {
  await cloudClearList();
  activeMeals = new Set();
  document.querySelectorAll(".meal-row button").forEach(b => b.classList.remove("active"));
  document.querySelectorAll(".weekly-group__content button").forEach(b => b.classList.remove("active"));
  document.querySelectorAll(".weekly-group").forEach(card => {
    card.classList.remove("open");
    card.querySelector(".weekly-group__header").classList.remove("active");
    card.querySelector(".weekly-group__chev").textContent = "‚ñ∫";
  });
  updateCounter();
});

/* ---------- Init ---------- */
renderMeals();
renderWeeklies();
updateCounter();
</script>
</body>
</html>
